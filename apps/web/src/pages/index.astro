---
import WebsiteLayout from "@/layouts/WebsiteLayout.astro";
import { getClient } from "@/lib/sanity";
import { HOME_QUERY, GLOBAL_QUERY } from "@packages/sanity/queries";
import type { HOME_QUERYResult } from "@packages/sanity/types";
import SectionRenderer from "@/components/sections/SectionRenderer.astro";
import config from "@/config";

const sanityClient = getClient();

// Get country code from middleware
const countryCode = Astro.locals.countryCode || config.defaultCountryCode;

const [homeData, globalData] = await Promise.all([
  sanityClient.fetch<HOME_QUERYResult>(HOME_QUERY),
  sanityClient.fetch(GLOBAL_QUERY),
]);
---

<WebsiteLayout
  title={homeData?.title || "Munchies"}
  description={homeData?.seo?.description || "Delicious cookies delivered to your door"}
  header={globalData?.header}
  footer={globalData?.footer}
>
  <SectionRenderer sections={homeData?.sections} fieldName="sections" countryCode={countryCode} />
</WebsiteLayout>
