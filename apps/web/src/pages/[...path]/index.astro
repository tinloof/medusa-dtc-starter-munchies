---
import { all } from "better-all";
import SectionRenderer from "@/components/sections/section-renderer.astro";
import TextPage from "@/components/text-page/index.astro";
import Layout from "@/layouts/layout.astro";
import { loadGlobalData, loadPageByPathname } from "@/lib/sanity";

const { path } = Astro.params;
const { countryCode, defaultCountryCode } = Astro.locals;

const pathSegments = path ? path.split("/") : [];

// Check if we are on a country code route
const isCountryCode = countryCode !== defaultCountryCode;

// Extract the actual path without country code
const actualPath = isCountryCode ? pathSegments.slice(1).join("/") : path;
const pathname = actualPath ? `/${actualPath}` : "/";

const { globalData, page } = await all({
  globalData() {
    return loadGlobalData();
  },
  page() {
    return loadPageByPathname(pathname);
  },
});

if (!page) {
  return Astro.redirect("/404", 404);
}

const templates: Record<string, any> = {
  "text.page": TextPage,
  home: SectionRenderer,
  "modular.page": SectionRenderer,
};

const Template = templates[page._type];

Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=300, stale-while-revalidate=3600"
);
---

<Layout
  title={page.title}
  description={page.seo?.description}
  globalData={globalData}
>
  {Template ? <Template {...page} /> : <div>Template not found: {page._type}</div>}
</Layout>
