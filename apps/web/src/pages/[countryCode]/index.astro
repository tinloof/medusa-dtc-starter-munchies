---
import WebsiteLayout from "@/layouts/WebsiteLayout.astro";
import { getClient } from "@/lib/sanity";
import { HOME_QUERY, GLOBAL_QUERY } from "@packages/sanity/queries";
import type { HOME_QUERYResult } from "@packages/sanity/types";
import SectionRenderer from "@/components/sections/SectionRenderer.astro";
import config from "@/config";

export function getStaticPaths() {
  // Exclude default country code - it's handled by root index.astro
  return config.supportedCountryCodes
    .filter((code) => code !== config.defaultCountryCode)
    .map((code) => ({
      params: { countryCode: code },
    }));
}

// Home pages are prerendered at build time
export const prerender = true;

const { countryCode } = Astro.params;

// Validate country code
if (!countryCode || !config.supportedCountryCodes.includes(countryCode.toLowerCase())) {
  return Astro.redirect(`/${config.defaultCountryCode}`);
}

const normalizedCountryCode = countryCode.toLowerCase();
const sanityClient = getClient();

const [homeData, globalData] = await Promise.all([
  sanityClient.fetch<HOME_QUERYResult>(HOME_QUERY),
  sanityClient.fetch(GLOBAL_QUERY),
]);
---

<WebsiteLayout
  title={homeData?.title || "Munchies"}
  description={homeData?.seo?.description || "Delicious cookies delivered to your door"}
  header={globalData?.header}
  footer={globalData?.footer}
>
  <SectionRenderer sections={homeData?.sections} fieldName="sections" countryCode={normalizedCountryCode} />
</WebsiteLayout>
