---
import WebsiteLayout from "@/layouts/WebsiteLayout.astro";
import { getClient } from "@/lib/sanity";
import { PRODUCT_QUERY, GLOBAL_QUERY } from "@packages/sanity/queries";
import type { PRODUCT_QUERYResult } from "@packages/sanity/types";
import { getProductByHandle, getProductsByIds } from "@/lib/medusa/products";
import { getRegion } from "@/lib/medusa/regions";
import SectionRenderer from "@/components/sections/SectionRenderer.astro";
import { ProductImagesCarousel } from "@/components/product/ImageCarousel";
import ProductInformation from "@/components/product/ProductInformation";
import StickyAtc from "@/components/product/StickyAtc";
import config from "@/config";

// SSR for product pages (handles non-default country codes)
export const prerender = false;

const { countryCode, handle } = Astro.params;

if (!handle || !countryCode) {
  return Astro.redirect('/404', 404);
}

// Validate country code
if (!config.supportedCountryCodes.includes(countryCode.toLowerCase())) {
  return Astro.redirect('/404', 404);
}

// Redirect if trying to access with default country code (should be at /products/[handle])
if (countryCode.toLowerCase() === config.defaultCountryCode) {
  return Astro.redirect(`/products/${handle}`, 308);
}

const normalizedCountryCode = countryCode.toLowerCase();

// Get region for pricing
const region = await getRegion(normalizedCountryCode);
if (!region) {
  console.error("No region found for country:", normalizedCountryCode);
  return Astro.redirect('/404', 404);
}

// Fetch product from Medusa
const product = await getProductByHandle(handle, region.id);
if (!product) {
  console.error("No product found for handle:", handle);
  return Astro.redirect('/404', 404);
}

// Fetch product content from Sanity
const sanityClient = getClient();
const [content, globalData] = await Promise.all([
  sanityClient.fetch<PRODUCT_QUERYResult>(PRODUCT_QUERY, { handle }),
  sanityClient.fetch(GLOBAL_QUERY),
]);

// Fetch addon products if any
const addonIds = content?.addons?.products?.map((p) => p._ref) || [];
const addonProducts = addonIds.length > 0
  ? (await getProductsByIds(addonIds, region.id)).products
  : [];

// Read URL params to get initial selected options (prevents price flash on hydration)
const initialSelectedOptions: Record<string, string | undefined> = {};
product.options?.forEach((option) => {
  const key = option.title.toLowerCase();
  const urlValue = Astro.url.searchParams.get(key);
  if (urlValue) {
    initialSelectedOptions[key] = urlValue;
  } else {
    initialSelectedOptions[key] = option.values?.[0]?.value.toLowerCase() ?? "";
  }
});

const title = content?.seo?.title || product.title || "Product";
const description = content?.seo?.description || product.description || "";
---

<WebsiteLayout
  title={title}
  description={description}
  header={globalData?.header}
  footer={globalData?.footer}
>
  <section class="mx-auto flex max-w-max-screen flex-col items-start justify-start gap-s lg:flex-row lg:gap-xs lg:px-xl lg:py-m">
    <ProductImagesCarousel client:load product={product} />
    <ProductInformation
      client:load
      addonProducts={addonProducts}
      content={content}
      initialSelectedOptions={initialSelectedOptions}
      region_id={region.id}
      countryCode={normalizedCountryCode}
      {...product}
    />
  </section>

  {content?.sections ? (
    <SectionRenderer
      countryCode={normalizedCountryCode}
      fieldName="body"
      sections={content.sections}
    />
  ) : null}

  <StickyAtc client:load initialSelectedOptions={initialSelectedOptions} {...product} region_id={region.id} />
</WebsiteLayout>
